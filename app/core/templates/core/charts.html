{% extends "core/base.html" %}
{% load static %}

{% block title %}SINTER - Gráficos{% endblock %}

{% block nav_title %}
Gráficos (sem IA)
{% endblock %}

{% block nav_actions %}
<a class="btn btn-outline-primary btn-sm" href="{% url 'core-index' %}">
    <i class="fas fa-arrow-left me-1"></i>Voltar
</a>
{% endblock %}

{% block body %}
<div class="container">
    <div class="document-container">
        <h4 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Gerar gráfico</h4>
        <form method="post" class="row g-3">
            {% csrf_token %}
            <div class="col-12 col-md-4">
                <label class="form-label">Tabela</label>
                <select class="form-select" name="table" id="table-select">
                    <option value="">Selecione...</option>
                    {% for tbl in tables %}
                        <option value="{{ tbl }}" {% if tbl == selected_table %}selected{% endif %}>{{ tbl }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Eixo X (categoria)</label>
                <div class="typeahead-wrapper">
                    <input
                        type="text"
                        class="form-control"
                        name="label_col"
                        id="label-col-input"
                        data-source="label-columns"
                        placeholder="Selecione ou digite..."
                        autocomplete="off"
                        value="{{ selected_label }}"
                    >
                    <div class="typeahead-results d-none" id="label-col-results"></div>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <label class="form-label">Valor do eixo X (opcional)</label>
                <select class="form-select" name="label_value" id="label-value-select">
                    <option value="">Todos</option>
                    {% for value in label_values %}
                        <option value="{{ value }}" {% if value == selected_label_value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Filtra apenas um registro da coluna do eixo X.</div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Agregação</label>
                <select class="form-select" name="agg" id="agg-select">
                    <option value="count" {% if selected_agg == 'count' %}selected{% endif %}>COUNT</option>
                    <option value="sum" {% if selected_agg == 'sum' %}selected{% endif %}>SUM</option>
                    <option value="avg" {% if selected_agg == 'avg' %}selected{% endif %}>AVG</option>
                </select>
                <div class="form-text">COUNT ignora a coluna numérica.</div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Coluna para agregação</label>
                <div class="typeahead-wrapper">
                    <input
                        type="text"
                        class="form-control"
                        name="value_col"
                        id="value-col-input"
                        data-source="value-columns"
                        placeholder="Selecione ou digite..."
                        autocomplete="off"
                        value="{{ selected_value }}"
                    >
                    <div class="typeahead-results d-none" id="value-col-results"></div>
                </div>
                <div class="form-text">Para COUNT, a coluna é opcional (usa COUNT(*)).</div>
            </div>
            <div class="col-md-4">
                <label class="form-label">Valor do eixo Y (opcional)</label>
                <select class="form-select" name="value_value" id="value-value-select">
                    <option value="">Todos</option>
                    {% for value in value_values %}
                        <option value="{{ value }}" {% if value == selected_value_value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Filtra registros pela coluna selecionada.</div>
            </div>
            <div class="col-12">
                <label class="form-label">Filtros</label>
                <div id="filter-list" class="d-grid gap-3">
                    {% for row in filter_rows %}
                        <div class="row g-3 align-items-end filter-row">
                            <div class="col-12 col-md-2">
                                <label class="form-label">Operador</label>
                                <input type="hidden" name="filter_op" class="filter-op-value" value="{{ row.op }}">
                                <div class="d-flex gap-2 filter-op-group {% if forloop.first %}opacity-50{% endif %}">
                                    <div class="form-check form-check-inline">
                                        <input
                                            class="form-check-input filter-op-radio"
                                            type="radio"
                                            name="filter_op_ui_{{ forloop.counter0 }}"
                                            id="filter-op-and-{{ forloop.counter0 }}"
                                            value="and"
                                            data-op="and"
                                            {% if row.op == 'and' %}checked{% endif %}
                                            {% if forloop.first %}disabled{% endif %}
                                        >
                                        <label class="form-check-label filter-op-label" data-op="and" for="filter-op-and-{{ forloop.counter0 }}">E</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input
                                            class="form-check-input filter-op-radio"
                                            type="radio"
                                            name="filter_op_ui_{{ forloop.counter0 }}"
                                            id="filter-op-or-{{ forloop.counter0 }}"
                                            value="or"
                                            data-op="or"
                                            {% if row.op == 'or' %}checked{% endif %}
                                            {% if forloop.first %}disabled{% endif %}
                                        >
                                        <label class="form-check-label filter-op-label" data-op="or" for="filter-op-or-{{ forloop.counter0 }}">OU</label>
                                    </div>
                                </div>
                                {% if forloop.first %}
                                    <div class="form-text">Primeiro filtro.</div>
                                {% endif %}
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Filtro (coluna)</label>
                                <div class="typeahead-wrapper">
                                    <input
                                        type="text"
                                        class="form-control filter-col-input"
                                        name="filter_col"
                                        data-source="filter-columns"
                                        placeholder="Selecione ou digite..."
                                        autocomplete="off"
                                        value="{{ row.col }}"
                                    >
                                    <div class="typeahead-results d-none filter-col-results"></div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Valor do filtro</label>
                                <select class="form-select filter-value-select" name="filter_value">
                                    <option value="">Todos</option>
                                    {% for value in row.values %}
                                        <option value="{{ value }}" {% if value == row.value %}selected{% endif %}>{{ value }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-md-2 d-flex">
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary btn-remove-filter mt-auto"
                                    {% if filter_rows|length == 1 %}disabled{% endif %}
                                >
                                    Remover filtro
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-3" id="add-filter">
                    <i class="fas fa-plus me-1"></i>Adicionar filtro
                </button>
            </div>
            <div class="w-100 d-none d-md-block"></div>
            <div class="col-md-4">
                <label class="form-label">Tipo de gráfico</label>
                <select class="form-select" name="chart_type">
                    <option value="bar" {% if selected_chart_type == 'bar' %}selected{% endif %}>Barras</option>
                    <option value="line" {% if selected_chart_type == 'line' %}selected{% endif %}>Linha</option>
                    <option value="pie" {% if selected_chart_type == 'pie' %}selected{% endif %}>Pizza</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Limite</label>
                <input type="number" class="form-control" name="limit" value="{{ selected_limit }}" min="1" max="200">
            </div>
            <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary btn-custom" type="submit" name="action" value="generate_chart">
                    <i class="fas fa-chart-bar me-1"></i>Gerar gráfico
                </button>
            </div>
        </form>
    </div>

    {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>{{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {% if chart_error %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-chart-bar me-2"></i>{{ chart_error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {% if chart_data %}
        <div class="document-container chart-card chart-card--compact mt-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>{{ chart_data.title }}</h5>
                <small class="text-white">Dados retornados da consulta.</small>
            </div>
            <canvas id="result-chart" height="280"></canvas>
        </div>
        {{ chart_data|json_script:"chart-data" }}
    {% endif %}
</div>
{{ columns|json_script:"label-columns" }}
{{ numeric_columns|json_script:"value-columns" }}
{{ columns|json_script:"filter-columns" }}
{{ columns|json_script:"all-columns" }}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'core/js/charts.js' %}"></script>
{% endblock %}
