{% extends "core/base.html" %}
{% load static %}
{% load core_extras %}

{% block title %}SINTER - Gráficos{% endblock %}

{% block nav_title %}
Filtros (sem IA)
{% endblock %}

{% block nav_actions %}
<a class="btn btn-outline-primary btn-sm" href="{% url 'core-index' %}">
    <i class="fas fa-arrow-left me-1"></i>Voltar
</a>
{% endblock %}

{% block body %}
<div class="charts-page">
    <div class="container-fluid px-0">
        <div class="row g-4 mx-0">
            <div class="col-12 col-lg-3 ps-0">
                <div class="sidebar">
                <h5 class="d-flex align-items-center mb-3">
                    <i class="fas fa-layer-group me-2 text-info"></i>Visualização
                </h5>
                <div class="view-toggle js-view-toggle mb-3">
                    <div class="view-toggle__chip" data-mode="chart">
                        <i class="fas fa-chart-column me-1"></i>Gráfico
                    </div>
                    <div class="form-check form-switch m-0">
                        <input class="form-check-input js-view-mode-switch" type="checkbox" role="switch" id="view-mode-switch-side" {% if view_mode != 'table' %}checked{% endif %}>
                        <label class="form-check-label" for="view-mode-switch-side">
                            <span class="visually-hidden">Alternar visualização</span>
                        </label>
                    </div>
                    <div class="view-toggle__chip" data-mode="table">
                        <i class="fas fa-table me-1"></i>Tabela
                    </div>
                </div>
                <p class="text-white small mb-0">Alterne entre gráfico e tabela para desbloquear as opções específicas.</p>
            </div>
        </div>
        <div class="col-12 col-lg-8">
            <div class="document-container panel-sidebar">
        <h4 class="mb-3"><i class="fas fa-sliders-h me-2"></i>Gerar gráfico</h4>
        <form method="post" class="row g-3" id="chart-form">
            {% csrf_token %}
            <input type="hidden" name="view_mode" id="view-mode-input" value="{{ view_mode|default:'chart' }}">
            <input type="hidden" name="page" id="page-input" value="{{ page|default:1 }}">
            <input type="hidden" name="action" id="action-input" value="refresh">
            <div class="col-12 col-md-4">
                <label class="form-label">Tabela</label>
                <select class="form-select" name="table" id="table-select">
                    <option value="">Selecione...</option>
                    {% for tbl in tables %}
                        <option value="{{ tbl }}" {% if tbl == selected_table %}selected{% endif %}>{{ tbl }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 col-md-4" data-view="chart">
                <label class="form-label">Eixo X (categoria)</label>
                <div class="typeahead-wrapper">
                    <input
                        type="text"
                        class="form-control"
                        name="label_col"
                        id="label-col-input"
                        data-source="label-columns"
                        placeholder="Selecione ou digite..."
                        autocomplete="off"
                        value="{{ selected_label }}"
                    >
                    <div class="typeahead-results d-none" id="label-col-results"></div>
                </div>
            </div>
            <div class="col-12 col-md-4" data-view="chart">
                <label class="form-label">Valor do eixo X (opcional)</label>
                <select class="form-select" name="label_value" id="label-value-select">
                    <option value="">Todos</option>
                    {% for value in label_values %}
                        <option value="{{ value }}" {% if value == selected_label_value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Filtra apenas um registro da coluna do eixo X.</div>
            </div>
            <div class="col-md-4" data-view="chart">
                <label class="form-label">Agregação</label>
                <select class="form-select" name="agg" id="agg-select">
                    <option value="count" {% if selected_agg == 'count' %}selected{% endif %}>Contagem</option>
                    <option value="sum" {% if selected_agg == 'sum' %}selected{% endif %}>Soma</option>
                    <option value="avg" {% if selected_agg == 'avg' %}selected{% endif %}>Média</option>
                </select>
                <div class="form-text">Contagem ignora a coluna numérica.</div>
            </div>
            <div class="col-md-4" data-view="chart">
                <label class="form-label">Coluna para agregação</label>
                <div class="typeahead-wrapper">
                    <input
                        type="text"
                        class="form-control"
                        name="value_col"
                        id="value-col-input"
                        data-source="value-columns"
                        placeholder="Selecione ou digite..."
                        autocomplete="off"
                        value="{{ selected_value }}"
                    >
                    <div class="typeahead-results d-none" id="value-col-results"></div>
                </div>
                <div class="form-text">Para Contagem, a coluna é desativada.</div>
            </div>
            <div class="col-md-4" data-view="chart">
                <label class="form-label">Valor do eixo Y (opcional)</label>
                <select class="form-select" name="value_value" id="value-value-select">
                    <option value="">Todos</option>
                    {% for value in value_values %}
                        <option value="{{ value }}" {% if value == selected_value_value %}selected{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Filtra registros pela coluna selecionada.</div>
            </div>
            <div class="col-12 col-md-6" data-view="table">
                <label class="form-label">Colunas da tabela</label>
                <input
                    type="text"
                    class="form-control mb-2"
                    id="table-cols-filter"
                    placeholder="Filtrar colunas..."
                    autocomplete="off"
                >
                <div class="d-flex gap-2 mb-2 table-cols-actions">
                    <button type="button" class="btn btn-outline-light btn-sm" id="table-cols-select-all">Selecionar tudo</button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="table-cols-clear">Limpar</button>
                </div>
                <div class="table-cols-list" id="table-cols-list">
                    {% for col in columns %}
                        <label class="table-cols-item" data-col="{{ column_display_map|get_item:col|default:col|lower }}">
                            <input
                                type="checkbox"
                                name="table_cols"
                                value="{{ col }}"
                                {% if col in selected_table_cols %}checked{% endif %}
                            >
                            <span>{{ column_display_map|get_item:col|default:col }}</span>
                        </label>
                    {% endfor %}
                </div>
                <div class="form-text text-warning d-none" id="table-cols-groupby-hint">
                    As colunas da tabela ficam desabilitadas quando o agrupamento está ativo.
                </div>
                <div class="form-text">Selecione uma ou mais colunas para a tabela.</div>
            </div>
            <div class="col-12 col-md-4" data-view="table">
                <label class="form-label">Agrupar por (opcional)</label>
                <div class="typeahead-wrapper">
                    <input
                        type="text"
                        class="form-control"
                        name="table_group_by"
                        id="table-group-by-input"
                        data-source="filter-columns"
                        data-use-table-filter="1"
                        placeholder="Selecione ou digite a coluna..."
                        autocomplete="off"
                        value="{{ selected_table_group_by }}"
                    >
                    <div class="typeahead-results d-none" id="table-group-by-results"></div>
                </div>
                <div class="form-text">Se definido, a tabela será agregada por esta coluna.</div>
            </div>
            <div class="col-12 col-md-4" data-view="table">
                <label class="form-label">Agregação</label>
                <select class="form-select" name="table_group_agg" id="table-group-agg">
                    <option value="count" {% if selected_table_group_agg == 'count' %}selected{% endif %}>Contagem</option>
                    <option value="sum" {% if selected_table_group_agg == 'sum' %}selected{% endif %}>Soma</option>
                    <option value="avg" {% if selected_table_group_agg == 'avg' %}selected{% endif %}>Média</option>
                </select>
            </div>
            <div class="col-12 col-md-4" data-view="table">
                <label class="form-label">Coluna para agregação</label>
                <div class="typeahead-wrapper">
                    <input
                        type="text"
                        class="form-control"
                        name="table_group_value"
                        id="table-group-value-input"
                        data-source="value-columns"
                        data-use-table-filter="1"
                        placeholder="Selecione ou digite..."
                        autocomplete="off"
                        value="{{ selected_table_group_value }}"
                    >
                    <div class="typeahead-results d-none" id="table-group-value-results"></div>
                </div>
                <div class="form-text">Para opção Contagem, a coluna é desativada.</div>
            </div>
            <div class="col-12">
                <label class="form-label">Filtros</label>
                <div id="filter-list" class="d-grid gap-3">
                    {% for row in filter_rows %}
                        <div class="row g-3 align-items-stretch filter-row">
                            <div class="col-12 col-md-2">
                                <label class="form-label">Operador</label>
                                <input type="hidden" name="filter_op" class="filter-op-value" value="{{ row.op }}">
                                <div class="d-flex gap-2 filter-op-group {% if forloop.first %}opacity-50{% endif %}">
                                    <div class="form-check form-check-inline">
                                        <input
                                            class="form-check-input filter-op-radio"
                                            type="radio"
                                            name="filter_op_ui_{{ forloop.counter0 }}"
                                            id="filter-op-and-{{ forloop.counter0 }}"
                                            value="and"
                                            data-op="and"
                                            {% if row.op == 'and' %}checked{% endif %}
                                            {% if forloop.first %}disabled{% endif %}
                                        >
                                        <label class="form-check-label filter-op-label" data-op="and" for="filter-op-and-{{ forloop.counter0 }}">E</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input
                                            class="form-check-input filter-op-radio"
                                            type="radio"
                                            name="filter_op_ui_{{ forloop.counter0 }}"
                                            id="filter-op-or-{{ forloop.counter0 }}"
                                            value="or"
                                            data-op="or"
                                            {% if row.op == 'or' %}checked{% endif %}
                                            {% if forloop.first %}disabled{% endif %}
                                        >
                                        <label class="form-check-label filter-op-label" data-op="or" for="filter-op-or-{{ forloop.counter0 }}">OU</label>
                                    </div>
                                </div>
                                {% if forloop.first %}
                                    <div class="form-text">Primeiro filtro.</div>
                                {% endif %}
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Filtro (coluna)</label>
                                <div class="typeahead-wrapper">
                                    <input
                                        type="text"
                                        class="form-control filter-col-input"
                                        name="filter_col"
                                        data-source="filter-columns"
                                        placeholder="Selecione ou digite..."
                                        autocomplete="off"
                                        value="{{ row.display_col }}"
                                    >
                                    <div class="typeahead-results d-none filter-col-results"></div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <label class="form-label">Valor do filtro</label>
                                {% if row.allow_text %}
                                    <input
                                        type="text"
                                        class="form-control filter-value-input"
                                        name="filter_value"
                                        list="filter-values-{{ forloop.counter0 }}"
                                        placeholder="Digite o valor..."
                                        autocomplete="off"
                                        value="{{ row.value }}"
                                    >
                                    <datalist id="filter-values-{{ forloop.counter0 }}">
                                        {% for value in row.values %}
                                            <option value="{{ value }}"></option>
                                        {% endfor %}
                                    </datalist>
                                    <div class="form-text text-warning filter-value-hint">Muitos valores. Digite para filtrar.</div>
                                {% else %}
                                    <select class="form-select filter-value-select" name="filter_value">
                                        <option value="">Todos</option>
                                        {% for value in row.values %}
                                            <option value="{{ value }}" {% if value == row.value %}selected{% endif %}>{{ value }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </div>
                            <div class="col-12 col-md-2 d-flex flex-column">
                                <span class="form-label d-block invisible">Ação</span>
                                <button
                                    type="button"
                                    class="btn btn-outline-secondary btn-remove-filter"
                                    {% if filter_rows|length == 1 %}disabled{% endif %}
                                >
                                    Remover filtro
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mt-3" id="add-filter">
                    <i class="fas fa-plus me-1"></i>Adicionar filtro
                </button>
            </div>
            <div class="w-100 d-none d-md-block" data-view="chart"></div>
            <div class="col-md-4" data-view="chart">
                <label class="form-label">Tipo de gráfico</label>
                <select class="form-select" name="chart_type">
                    <option value="bar" {% if selected_chart_type == 'bar' %}selected{% endif %}>Barras</option>
                    <option value="line" {% if selected_chart_type == 'line' %}selected{% endif %}>Linha</option>
                    <option value="pie" {% if selected_chart_type == 'pie' %}selected{% endif %}>Pizza</option>
                </select>
            </div>
            <div class="col-md-3" data-view="chart">
                <label class="form-label">Limite</label>
                <input type="number" class="form-control" name="limit" id="limit-input" value="{{ selected_limit }}" min="1" max="200">
            </div>
            <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary btn-custom" type="button" id="generate-btn">
                    <i class="fas {% if view_mode == 'table' %}fa-table{% else %}fa-chart-bar{% endif %} me-1" id="generate-icon"></i>
                    <span id="generate-label">{% if view_mode == 'table' %}Gerar tabela{% else %}Gerar gráfico{% endif %}</span>
                </button>
            </div>
        </form>
    </div>

    {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>{{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {% if chart_error %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="fas fa-chart-bar me-2"></i>{{ chart_error }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}

    {% if chart_data or table_rows %}
        {% if view_mode == 'table' %}
            <div class="document-container panel-sidebar chart-card chart-card--compact mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>Resultado da consulta
                                <small class="text-white ms-2">({{ total_rows }} linhas)</small>
                            </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-light btn-sm download-csv" type="button" data-action="download_csv">
                            <i class="fas fa-download me-1"></i>Baixar CSV
                        </button>
                    </div>
                </div>
                {% if table_rows %}
                    <div class="table-responsive">
                        <table class="table table-primary table-striped align-middle mb-0">
                            <thead>
                                <tr>
                                    {% for header in table_headers %}
                                        <th scope="col">{{ header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in table_rows %}
                                    <tr>
                                        {% for cell in row %}
                                            <td>{{ cell }}</td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if total_pages > 1 %}
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-white">Página {{ page }} de {{ total_pages }} ({{ total_rows }} registros)</small>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm js-page-btn" type="button" data-page="{{ page|add:'-1' }}" {% if page <= 1 %}disabled{% endif %}>Anterior</button>
                                <button class="btn btn-outline-secondary btn-sm js-page-btn" type="button" data-page="{{ page|add:'1' }}" {% if page >= total_pages %}disabled{% endif %}>Próxima</button>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert alert-secondary mb-0">Nenhum dado encontrado para a consulta.</div>
                {% endif %}
            </div>
        {% else %}
            {% if chart_data %}
                <div class="document-container panel-sidebar chart-card chart-card--compact mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>{{ chart_data.title }}</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-light btn-sm download-csv" type="button" data-action="download_csv">
                                <i class="fas fa-download me-1"></i>Baixar CSV
                            </button>
                            <button class="btn btn-outline-light btn-sm" type="button" id="download-chart">
                                <i class="fas fa-image me-1"></i>Baixar PNG
                            </button>
                        </div>
                    </div>
                    <canvas id="result-chart" height="280"></canvas>
                </div>
                {{ chart_data|json_script:"chart-data" }}
            {% else %}
                <div class="alert alert-secondary">Nenhum dado encontrado para a consulta.</div>
            {% endif %}
        {% endif %}
    {% endif %}
            </div>
        </div>
    </div>
</div>
{{ display_columns|json_script:"label-columns" }}
{{ display_numeric_columns|json_script:"value-columns" }}
{{ display_columns|json_script:"filter-columns" }}
{{ display_columns|json_script:"all-columns" }}
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'core/js/charts.js' %}"></script>
{% endblock %}
